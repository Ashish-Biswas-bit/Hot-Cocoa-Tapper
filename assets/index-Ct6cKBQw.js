(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const c of n)if(c.type==="childList")for(const m of c.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&a(m)}).observe(document,{childList:!0,subtree:!0});function e(n){const c={};return n.integrity&&(c.integrity=n.integrity),n.referrerPolicy&&(c.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?c.credentials="include":n.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function a(n){if(n.ep)return;n.ep=!0;const c=e(n);fetch(n.href,c)}})();class Ae{ctx;constants;bartenderImgs={};emptyMugImg=null;backgroundImg=null;mugImg=null;patronImgs=[];animationFrame=0;constructor(s,e){const a=s.getContext("2d");if(!a)throw new Error("Could not get 2D context");this.ctx=a,this.constants=e,this.loadImages()}loadImages(){this.emptyMugImg=new Image,this.emptyMugImg.src="https://0199d9cb-ffe1-73b1-8e8d-3be2409e6e3b.mochausercontent.com/empty_mug.png",this.bartenderImgs.idle=new Image,this.bartenderImgs.idle.src="https://0199d9cb-ffe1-73b1-8e8d-3be2409e6e3b.mochausercontent.com/bartender_Empty_hands_1.png",this.bartenderImgs.filling=new Image,this.bartenderImgs.filling.src="https://0199d9cb-ffe1-73b1-8e8d-3be2409e6e3b.mochausercontent.com/bartender_refilling_mug_1.png",this.bartenderImgs.serving=new Image,this.bartenderImgs.serving.src="https://0199d9cb-ffe1-73b1-8e8d-3be2409e6e3b.mochausercontent.com/bartender_serving_1.png",this.bartenderImgs.catching=new Image,this.bartenderImgs.catching.src="https://0199d9cb-ffe1-73b1-8e8d-3be2409e6e3b.mochausercontent.com/bartender_catch_empty_mug.png",this.bartenderImgs.receiving=new Image,this.bartenderImgs.receiving.src="https://0199d9cb-ffe1-73b1-8e8d-3be2409e6e3b.mochausercontent.com/bartender_receiving_1.png",this.backgroundImg=new Image,this.backgroundImg.src="https://mocha-cdn.com/0199d9cb-ffe1-73b1-8e8d-3be2409e6e3b/HCT_Background.png",this.mugImg=new Image,this.mugImg.src="https://mocha-cdn.com/0199d9cb-ffe1-73b1-8e8d-3be2409e6e3b/HCT_Mug.png",["https://0199d9cb-ffe1-73b1-8e8d-3be2409e6e3b.mochausercontent.com/character_patron_walk_1.png","https://0199d9cb-ffe1-73b1-8e8d-3be2409e6e3b.mochausercontent.com/character_patron_walk_2.png","https://0199d9cb-ffe1-73b1-8e8d-3be2409e6e3b.mochausercontent.com/character_patron_walk_3.png","https://0199d9cb-ffe1-73b1-8e8d-3be2409e6e3b.mochausercontent.com/character_patron_walk_4.png"].forEach((e,a)=>{const n=new Image;n.onload=()=>{this.patronImgs[a]=n},n.src=e})}getLaneY(s){return this.constants.LANE_Y_OFFSET+s*this.constants.LANE_HEIGHT+this.constants.LANE_HEIGHT/2}render(s){this.animationFrame+=1;const e=this.ctx,{CANVAS_WIDTH:a,CANVAS_HEIGHT:n,LANE_Y_OFFSET:c,LANE_HEIGHT:m,BARTENDER_X:o,MIN_ACCEPTABLE_FILL:g,MAX_FILL:f}=this.constants;if(s.screenShake>0){const t=(Math.random()-.5)*s.screenShake,l=(Math.random()-.5)*s.screenShake;e.save(),e.translate(t,l)}if(e.fillStyle="#2d1810",e.fillRect(0,0,a,n),this.backgroundImg&&this.backgroundImg.complete)e.drawImage(this.backgroundImg,0,0,a,n);else{e.fillStyle="#2d1810",e.fillRect(0,0,a,c-20),e.fillStyle="#1a0f0a",e.fillRect(0,c+4*m+20,a,n-(c+4*m+20));for(let t=0;t<4;t++){const l=this.getLaneY(t),r=a-o-60;e.fillStyle="rgba(0, 0, 0, 0.3)",e.fillRect(o+60,l+16,r,4);const h=e.createLinearGradient(o+60,l-15,o+60,l+15);h.addColorStop(0,"#7a5230"),h.addColorStop(.5,"#654321"),h.addColorStop(1,"#5a3a20"),e.fillStyle=h,e.fillRect(o+60,l-15,r,30),e.fillStyle="#9a7f5a",e.fillRect(o+60,l-16,r,2),e.fillStyle="#4a2f1a",e.fillRect(o+60,l+13,r,3),e.strokeStyle="rgba(90, 60, 40, 0.4)",e.lineWidth=1;for(let d=o+100;d<a-20;d+=50)e.beginPath(),e.moveTo(d,l-12),e.quadraticCurveTo(d+15,l,d+30,l+12),e.stroke();t<3&&(e.strokeStyle="rgba(0, 0, 0, 0.2)",e.lineWidth=1,e.beginPath(),e.moveTo(o+60,l+20),e.lineTo(a,l+20),e.stroke()),e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(15,l-18,30,30),e.fillStyle="#FFD700",e.font="bold 18px monospace",e.textAlign="center",e.fillText(`${t+1}`,30,l+5)}}const p=this.getLaneY(s.bartenderLane);let x="idle";s.bartenderState==="FILLING_MUG"?x="filling":s.bartenderState==="SLIDING_MUG"?x="serving":s.bartenderState==="CATCHING"?x="catching":s.bartenderState==="RECEIVING"&&(x="receiving");const T=this.bartenderImgs[x],b=64;e.save(),e.translate(o,p),s.bartenderFacing==="right"&&e.scale(-1,1);let v=0,M=0;if(s.bartenderState==="FILLING_MUG"?v=Math.sin(this.animationFrame*.3)*3:s.bartenderState==="SLIDING_MUG"&&(M=Math.sin(this.animationFrame*.5)*4),T&&T.complete?e.drawImage(T,-b/2+M,-b/2+v,b,b):(e.fillStyle="#4A90E2",e.fillRect(-b/2,-b/2,b,b),e.fillStyle="#FFFFFF",e.font="bold 12px monospace",e.textAlign="center",e.fillText("BARTENDER",0,5)),e.restore(),s.bartenderState!=="IDLE"){const t=Math.sin(this.animationFrame*.2)*3;e.fillStyle=s.bartenderState==="FILLING_MUG"?"#FFD700":"#44FF44",e.font="bold 11px monospace",e.textAlign="center";const l=s.bartenderState==="FILLING_MUG"?"â¤µ FILL":"â¤´ SERVE";e.fillText(l,o,p-45+t)}if(s.patrons.forEach((t,l)=>{const r=this.patronImgs[t.spriteIndex],h=this.animationFrame,d=l*.7,C=.2,D=!t.isWaiting&&!t.served?6:0,F=Math.sin(h*C+d)*D,E=!t.isWaiting&&!t.served?3:0,N=Math.sin(h*C*1.5+d)*E,fe=.12,me=t.isWaiting?3:0,ge=Math.sin(h*fe+d)*me,be=.06,pe=t.isWaiting?.08:0,Se=1+Math.sin(h*be+d)*pe,$=F+ge,ue=.12,Ie=t.isWaiting?.08:0,Fe=1+Math.sin(h*ue+d)*Ie,B=Se*Fe,O=t.isWaiting?t.waitingTime/t.patience:0,j=O>.7?(O-.7)/.3:0,J=j*6,Q=Math.sin(h*.6+d)*J,Z=Math.cos(h*.55+d)*J*.5,ye=.25,xe=j*.15,ee=Math.sin(h*ye+d)*xe,te=t.isDrinking?Math.sin(t.drinkingProgress/100)*.3:0,Le=t.isDrinking?Math.sin(t.drinkingProgress/80)*5:0,se=h*.2+d,z=t.served?Math.abs(Math.sin(se))*12:0,ie=t.served?Math.sin(se*2)*.2:0,q=1+Math.sin(h*C*2+d)*0,ae=1/q,ne=!t.isWaiting&&!t.served?Math.sin(h*C+d)*.12:0;if(r&&r.complete&&this.patronImgs.length>0){const A=r.width,G=r.height,R=A/G,_=48,u=_*R*B*q,y=_*B*ae,W=t.y+$-z+Z,K=t.x+Q+N;e.save(),e.translate(K,W);let U=!1;t.served||(e.scale(-1,1),U=!0),!t.isWaiting&&!t.served&&!t.isDrinking&&e.rotate(ne),t.isWaiting&&O>.7&&e.rotate(ee),t.isDrinking&&e.rotate(te),t.served&&e.rotate(ie);const Y=2,le=Y,oe=Y,re=A-Y*2,ce=G-Y*2;if(U?e.drawImage(r,le,oe,re,ce,-u/2*-1-u,-y/2,u,y):e.drawImage(r,le,oe,re,ce,-u/2,-y/2,u,y),e.restore(),t.isWaiting){const X=t.waitingTime/t.patience,V=40,he=6,de=t.y+$-z;e.fillStyle="#333",e.fillRect(t.x-V/2,de-35,V,he);const Ee=X>.7?"#FF2222":X>.4?"#FFAA00":"#44FF44";if(e.fillStyle=Ee,X>.7){const ve=Math.sin(h*.3)*.2+.8;e.globalAlpha=ve,e.shadowBlur=10,e.shadowColor="#FF0000"}e.fillRect(t.x-V/2,de-35,V*X,he),e.globalAlpha=1,e.shadowBlur=0}}else{const A=t.y+$-z+Z+Le,G=t.x+Q+N,R=30*B*q,_=40*B*ae;if(t.served)e.save(),e.translate(G,A),e.rotate(ie),e.fillStyle="#32CD32",e.fillRect(-R/2,-_/2,R,_),e.fillStyle="#FFFFFF",e.font="14px monospace",e.textAlign="center",e.fillText("HAPPY",0,5),e.restore();else{e.save(),e.translate(G,A),!t.isWaiting&&!t.served&&!t.isDrinking&&e.rotate(ne),t.isWaiting&&O>.7&&e.rotate(ee),t.isDrinking&&e.rotate(te),e.fillStyle=t.isDrinking?"#32CD32":t.isWaiting?"#4A90E2":"#FF6B6B",e.fillRect(-R/2,-_/2,R,_),e.fillStyle="#FFFFFF",e.font="14px monospace",e.textAlign="center";let P="";if(t.isDrinking?P="DRINK":t.isWaiting?P="WAIT":P="ANGRY",e.fillText(P,0,5),e.restore(),t.isWaiting){const u=t.waitingTime/t.patience,y=40,W=6;e.fillStyle="#333",e.fillRect(t.x-y/2,A-35,y,W);const K=u>.7?"#FF2222":u>.4?"#FFAA00":"#44FF44";if(e.fillStyle=K,u>.7){const U=Math.sin(h*.3)*.2+.8;e.globalAlpha=U,e.shadowBlur=10,e.shadowColor="#FF0000"}e.fillRect(t.x-y/2,A-35,y*u,W),e.globalAlpha=1,e.shadowBlur=0}}}}),s.mugs.forEach(t=>{const r=t.state==="at_patron"?.1:t.state==="sliding_forward"||t.state==="sliding_back"?.3:.2;e.save(),e.globalAlpha=r,e.fillStyle="#000000";const h=t.state==="sliding_forward"||t.state==="sliding_back"?20:18,d=4,C=t.x+(t.state==="sliding_forward"?2:t.state==="sliding_back"?-2:0);if(e.beginPath(),e.ellipse(C,t.y+18,h/2,d,0,0,Math.PI*2),e.fill(),e.restore(),(t.state==="sliding_forward"||t.state==="sliding_back")&&(e.save(),e.shadowBlur=8,e.shadowColor=t.state==="sliding_forward"?"rgba(255, 215, 0, 0.4)":"rgba(255, 107, 107, 0.4)"),this.mugImg&&this.mugImg.complete){let F=0,E=0;if(t.state==="sliding_forward"?(F=Math.sin(this.animationFrame*.3+t.id*.5)*2,E=Math.sin(this.animationFrame*.25+t.id*.3)*.05):t.state==="sliding_back"&&(F=Math.sin(this.animationFrame*.35+t.id*.5)*2.5,E=Math.sin(this.animationFrame*.3+t.id*.3)*-.08),e.save(),e.translate(t.x,t.y+F),e.rotate(E),t.isEmpty&&this.emptyMugImg&&this.emptyMugImg.complete?e.drawImage(this.emptyMugImg,-32/2,-32/2,32,32):e.drawImage(this.mugImg,-32/2,-32/2,32,32),e.restore(),e.globalAlpha=1,e.filter="none",!t.isEmpty&&t.fillLevel>0){const N=t.fillLevel/100;e.fillStyle=N>=.7?"#44FF44":N>=.4?"#FFAA00":"#FF4444",e.fillRect(t.x-12,t.y+10,24*N,4)}t.state==="sliding_back"&&(e.fillStyle="#FF6B6B",e.font="bold 10px monospace",e.textAlign="center",e.fillText("CATCH!",t.x,t.y-22))}else{let D=0,F=0;if(t.state==="sliding_forward"?(D=Math.sin(this.animationFrame*.3+t.id*.5)*2,F=Math.sin(this.animationFrame*.25+t.id*.3)*.05):t.state==="sliding_back"&&(D=Math.sin(this.animationFrame*.35+t.id*.5)*2.5,F=Math.sin(this.animationFrame*.3+t.id*.3)*-.08),e.fillStyle=t.isEmpty?"#666666":"#8B4513",e.save(),e.translate(t.x,t.y+D),e.rotate(F),e.fillRect(-10,-15,20,25),e.restore(),!t.isEmpty&&t.fillLevel>0){const E=t.fillLevel/100;e.fillStyle="#F5DEB3",e.fillRect(t.x-8,t.y-13+(1-E)*15,16,8*E)}e.strokeStyle="#8B4513",e.lineWidth=3,e.beginPath(),e.arc(t.x+12,t.y-5,6,0,Math.PI),e.stroke()}(t.state==="sliding_forward"||t.state==="sliding_back")&&e.restore()}),s.isFillingMug){const t=o-50,l=this.getLaneY(s.bartenderLane)-50,r=100,h=20;e.fillStyle="#333",e.fillRect(t,l,r,h);const d=s.currentFillLevel/f;e.fillStyle=d>=g/f?"#44FF44":"#FF4444",e.fillRect(t,l,r*d,h),e.strokeStyle="#FFF",e.lineWidth=2,e.strokeRect(t,l,r,h),e.fillStyle="#FFFFFF",e.font="bold 12px monospace",e.textAlign="center",e.fillText("FILLING...",t+r/2,l-5)}if(s.recentFailure){const t=Date.now()-s.recentFailure.timestamp;if(t<2e3){const l=1-t/2e3;e.save(),e.globalAlpha=l;const r=n/2,h=s.recentFailure.type==="miss"?"#FF4444":"#FF6666",d=s.recentFailure.type==="miss"?"âœ— MISSED CATCH!":"âœ— PATRON TIMEOUT!";e.fillStyle=h,e.font="bold 36px monospace",e.textAlign="center",e.shadowColor="#000000",e.shadowBlur=10,e.shadowOffsetX=2,e.shadowOffsetY=2,e.fillText(d,a/2,r),e.restore()}}const w=Math.ceil(s.timeLeft/1e3);e.textAlign="center",e.font="bold 20px monospace",e.fillStyle="#FFD700",e.fillText("TIME",a/2,22),e.font="bold 22px monospace",e.fillStyle=w<=10?"#FF4444":"#44FF44",e.fillText(`${w}s`,a/2,42),e.textAlign="left",e.textAlign="left",e.font="bold 18px monospace",e.fillStyle="#FFD700",e.fillText("HIGH SCORE",20,22),e.font="bold 22px monospace",e.fillStyle="#FFF8DC",e.fillText(`${s.highScore}`,20,42),e.font="bold 20px monospace",e.fillStyle="#FFD700",e.fillText("SCORE",20,68),e.font="bold 26px monospace",e.fillStyle="#FFFFFF",e.fillText(`${s.score}`,20,100);const L=220,I=20,k=s.health/100,S=(a-L)/2,i=n-28;if(e.fillStyle="#333",e.fillRect(S,i,L,I),e.fillStyle=k>.6?"#44FF44":k>.3?"#FFAA00":"#FF4444",e.fillRect(S,i,L*k,I),e.strokeStyle="#FFF",e.lineWidth=2,e.strokeRect(S,i,L,I),e.font="bold 18px monospace",e.fillStyle="#FFFFFF",e.textAlign="center",e.fillText(`${Math.floor(s.health)}%`,a/2,i+I-4),e.textAlign="left",s.comboPopup&&Date.now()-s.comboPopup.timestamp<2e3){const t=Date.now()-s.comboPopup.timestamp,l=Math.min(1,t/200),r=Math.max(0,1-t/2e3),h=-t/20;e.save(),e.translate(a/2,n/3+h),e.scale(l,l),e.globalAlpha=r,e.shadowColor="#FFD700",e.shadowBlur=30,e.fillStyle="#FFD700",e.font="bold 64px monospace",e.textAlign="center",e.fillText(`${s.comboPopup.value}X COMBO!`,0,0),e.shadowBlur=0,e.restore()}if(s.health>0&&s.health<30){const t=Math.sin(this.animationFrame*.15)*.3+.2;e.fillStyle=`rgba(255, 0, 0, ${t})`,e.fillRect(0,0,a,n)}if(s.screenShake>0&&e.restore(),s.gameOver){if(e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(0,0,a,n),e.fillStyle="#FF4444",e.font="bold 48px monospace",e.textAlign="center",e.fillText("GAME OVER",a/2,n/2-80),e.fillStyle="#FFFFFF",e.font="bold 24px monospace",e.fillText(`Final Score: ${s.score}`,a/2,n/2-30),s.health<=0)e.fillStyle="#FF6666",e.font="bold 20px monospace",e.fillText("Health depleted!",a/2,n/2+10);else if(s.score===s.highScore&&s.highScore>0)e.fillStyle="#FFD700",e.font="bold 26px monospace",e.fillText("New High Score!",a/2,n/2+10);else if(s.score>0&&s.score<s.highScore){e.fillStyle="#FF6666",e.font="bold 20px monospace";const t=s.highScore-s.score;e.fillText(`Score too low! ${t} required`,a/2,n/2+10)}e.fillStyle="#FFFFFF",e.font="bold 18px monospace",e.fillText("Press SPACE to play again",a/2,n/2+50)}else!s.isPlaying&&s.health>0&&(e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(0,0,a,n),e.fillStyle="#FFD700",e.font="bold 48px monospace",e.textAlign="center",e.fillText("HOT COCOA TAPPER",a/2,n/2-100),e.fillStyle="#FFFFFF",e.font="bold 18px monospace",e.fillText("Hold SPACE to fill mugs, release to serve",a/2,n/2-70),e.fillText("Well-filled mugs earn more points!",a/2,n/2-45),e.fillText("Mugs break if they fall off the bar",a/2,n/2-20),e.fillText("Use â†‘â†“ or W/S to move bartender",a/2,n/2+5),e.fillText("Meet score requirements to advance levels!",a/2,n/2+30),e.fillText("Press SPACE to start",a/2,n/2+65))}}class _e{state;renderer=null;gameLoopId=null;patronId=0;mugId=0;keysHeld=new Set;spawnAcc=0;prevTime=null;callbacks={};suppressNextServe=!1;CANVAS_WIDTH=700;CANVAS_HEIGHT=550;LANE_HEIGHT=100;LANE_Y_OFFSET=130;BARTENDER_X=100;BASE_PATRON_SPEED=.9;MUG_SPEED=3.6;MUG_RETURN_SPEED=3.4;BASE_PATRON_WAIT_TIME=2800;DRINKING_TIME=1e3;CATCH_RANGE=45;COMBO_TIMEOUT=5e3;FILL_SPEED=1.6;MAX_FILL=100;MIN_ACCEPTABLE_FILL=80;LEVEL_TIME=6e4;constructor(){this.state=this.getInitialState()}getInitialState(){const s=localStorage.getItem("hotcocoatapper_highscore");return{score:0,lives:3,level:1,isPlaying:!1,gameOver:!1,patrons:[],mugs:[],bartenderLane:0,bartenderState:"IDLE",bartenderFacing:"right",isFillingMug:!1,currentFillLevel:0,health:100,timeLeft:this.LEVEL_TIME,levelStartTime:0,combo:0,maxCombo:0,lastServeTime:0,screenShake:0,totalServes:0,perfectServes:0,highScore:s?parseInt(s):0}}setCallbacks(s){this.callbacks=s}init(){const s=document.getElementById("root");if(!s){console.error("Root element not found");return}s.innerHTML=`
      <div class="flex items-center justify-center w-screen h-screen fixed inset-0">
        <div class="flex flex-col items-center justify-center gap-3 sm:gap-4 md:gap-6 w-full max-w-4xl mx-auto px-8 sm:px-12 md:px-16 py-4 sm:py-6 md:py-8">
          <!-- Game Canvas Section -->
          <div class="relative w-full flex justify-center rounded-xl shadow-2xl" style="padding: 10px 191px;">
            <canvas id="game-canvas" width="${this.CANVAS_WIDTH}" height="${this.CANVAS_HEIGHT}"
                    class="border-4 sm:border-6 md:border-8 border-amber-600 rounded-lg shadow-2xl bg-gradient-to-b from-amber-900 to-amber-950"
                    style="display: block; aspect-ratio: 4/3; max-width: 100%;">
            </canvas>
            <!-- Retro-style decorative elements (hidden on mobile) -->
            <div class="hidden sm:block absolute -top-3 sm:-top-4 -left-3 sm:-left-4 w-6 sm:w-8 h-6 sm:h-8 bg-amber-400 rounded-full opacity-70 animate-pulse"></div>
            <div class="hidden sm:block absolute -top-3 sm:-top-4 -right-3 sm:-right-4 w-6 sm:w-8 h-6 sm:h-8 bg-orange-400 rounded-full opacity-70 animate-pulse delay-1000"></div>
            <div class="hidden sm:block absolute -bottom-3 sm:-bottom-4 -left-3 sm:-left-4 w-6 sm:w-8 h-6 sm:h-8 bg-red-400 rounded-full opacity-70 animate-pulse delay-2000"></div>
            <div class="hidden sm:block absolute -bottom-3 sm:-bottom-4 -right-3 sm:-right-4 w-6 sm:w-8 h-6 sm:h-8 bg-amber-400 rounded-full opacity-70 animate-pulse delay-3000"></div>
          </div>


          <!-- Game Info Section -->
          <div class="w-full space-y-2 sm:space-y-3 md:space-y-4 px-2 sm:px-0">
            <!-- Controls Info -->
            <div class="bg-black bg-opacity-70 rounded-lg px-3 sm:px-6 py-2 sm:py-3 border border-amber-600 text-center">
              <p class="text-amber-200 font-mono text-xs sm:text-sm">
                <span class="text-amber-400 font-bold">â†‘â†“/W/S</span> move â€¢ 
                <span class="text-amber-400 font-bold">SPACE</span> fill & serve
              </p>
            </div>

            

            <!-- Instructions -->
            <div class="bg-black bg-opacity-60 rounded-lg px-3 sm:px-6 py-3 sm:py-4 border border-amber-500 text-center">
              <p class="text-amber-200 font-mono text-xs sm:text-sm leading-relaxed">
                Hold SPACE to fill mugs! Release to serve. 70%+ fill = bonus points. Complete 60s levels by reaching score goals. Don't let patrons reach the bartender!
              </p>
            </div>
          </div>
        </div>
      </div>
    `;const e=document.getElementById("game-canvas");if(!e){console.error("Canvas element not found");return}this.renderer=new Ae(e,{CANVAS_WIDTH:this.CANVAS_WIDTH,CANVAS_HEIGHT:this.CANVAS_HEIGHT,LANE_HEIGHT:this.LANE_HEIGHT,LANE_Y_OFFSET:this.LANE_Y_OFFSET,BARTENDER_X:this.BARTENDER_X,MIN_ACCEPTABLE_FILL:this.MIN_ACCEPTABLE_FILL,MAX_FILL:this.MAX_FILL}),this.updateScoreDisplays(),this.setupEventListeners(),this.renderLoopId||(this.renderLoopId=requestAnimationFrame(this.renderLoop))}updateScoreDisplays(){const s=document.getElementById("score-display");s&&(s.textContent=String(this.state.score));const e=document.getElementById("highscore-display");e&&(e.textContent=`High Score: ${this.state.highScore}`)}setupEventListeners(){window.addEventListener("keydown",s=>this.handleKeyDown(s)),window.addEventListener("keyup",s=>this.handleKeyUp(s))}handleKeyDown(s){if(s.preventDefault(),this.keysHeld.add(s.key),s.code==="Space"&&!this.state.isPlaying){this.keysHeld.delete(" "),this.keysHeld.delete("Space"),this.suppressNextServe=!0,this.startGame();return}else this.state.isPlaying&&(s.key==="ArrowUp"||s.key==="w"||s.key==="W"?this.moveBartender("up"):(s.key==="ArrowDown"||s.key==="s"||s.key==="S")&&this.moveBartender("down"),(s.key===" "||s.key==="Space")&&(this.state.bartenderState==="RECEIVING"||this.state.bartenderState==="CATCHING")&&(this.state.bartenderState="FILLING_MUG",this.state.isFillingMug=!0,this.state.currentFillLevel=0,this.state.bartenderFacing="left"))}handleKeyUp(s){if(s.preventDefault(),this.keysHeld.delete(s.key),s.key===" "||s.key==="Space"){if(this.suppressNextServe){this.suppressNextServe=!1;return}this.state.isFillingMug&&this.serveMug()}}moveBartender(s){if(!this.state.isPlaying||!(this.state.bartenderState==="IDLE"||this.state.bartenderState==="RECEIVING"||this.state.bartenderState==="CATCHING"))return;let e=this.state.bartenderLane;s==="up"&&e>0?e--:s==="down"&&e<3&&e++,this.state.bartenderLane=e;const a=this.state.patrons.some(n=>n.lane===e&&!n.served);this.state.bartenderFacing=a?"right":"left"}getLaneY(s){return this.LANE_Y_OFFSET+s*this.LANE_HEIGHT+this.LANE_HEIGHT/2}serveMug(){if(!this.state.isFillingMug||this.state.currentFillLevel===0)return;const s=this.state.patrons.find(a=>a.lane===this.state.bartenderLane&&!a.served);if(!s){this.state.recentFailure={type:"miss",timestamp:Date.now()},this.state.isFillingMug=!1,this.state.currentFillLevel=0,this.state.bartenderState="IDLE";return}const e={id:this.mugId++,x:this.BARTENDER_X+80,y:this.getLaneY(this.state.bartenderLane),lane:this.state.bartenderLane,speed:this.MUG_SPEED+(this.state.level-1)*.2,fillLevel:this.state.currentFillLevel,state:"sliding_forward",isEmpty:!1,targetPatronId:s.id};this.state.mugs.push(e),this.state.isFillingMug=!1,this.state.currentFillLevel=0,this.state.bartenderState="SLIDING_MUG",this.state.bartenderFacing="right",setTimeout(()=>{this.state.bartenderState==="SLIDING_MUG"&&(this.state.bartenderState="IDLE")},300)}startGame(){const s=Date.now();this.state={...this.getInitialState(),isPlaying:!0,levelStartTime:s},this.patronId=0,this.mugId=0,this.prevTime=null,this.spawnAcc=0,this.gameLoopId!==null&&cancelAnimationFrame(this.gameLoopId),this.gameLoop()}gameLoop=()=>{if(!this.state.isPlaying||this.state.gameOver){this.gameLoopId=null;return}const s=Date.now(),e=s-this.state.levelStartTime,a=Math.max(0,this.LEVEL_TIME-e);if(a<=0){const i=this.state.level*2e3;if(this.state.score>=i){const t=this.state.level,l=this.state.score;this.state.level++,this.state.timeLeft=this.LEVEL_TIME,this.state.levelStartTime=s,this.state.score+=1e3,this.state.health=Math.min(100,this.state.health+25),this.state.patrons=[],this.state.mugs=[],this.callbacks.onLevelComplete&&this.callbacks.onLevelComplete(t,l)}else{const t=this.state.score-i;t>0&&t>this.state.highScore&&(this.state.highScore=t,localStorage.setItem("hotcocoatapper_highscore",String(this.state.highScore))),this.state.requiredScoreAtGameOver=i,this.state.gameOver=!0,this.state.isPlaying=!1,this.state.timeLeft=0,this.updateUI(),this.callbacks.onGameOver&&this.callbacks.onGameOver(this.state.score,this.state.level);return}}const n=performance.now();let c=0;this.prevTime===null?this.prevTime=n:(c=n-this.prevTime,this.prevTime=n);const m=1+(this.state.level-1)*.5,o=this.BASE_PATRON_SPEED*m,g=Math.max(300,this.BASE_PATRON_WAIT_TIME/m);this.spawnAcc+=c;const f=Math.max(700,1600-(this.state.level-1)*150),p=Math.max(200,f/m);if(this.spawnAcc>=p){this.spawnAcc-=p;for(let i=0;i<4;i++){const t=this.state.patrons.some(r=>r.lane===i&&!r.served),l=this.state.mugs.some(r=>r.lane===i&&r.state!=="empty");if(!t&&!l){const r={id:this.patronId++,x:this.CANVAS_WIDTH-60,y:this.getLaneY(i),lane:i,speed:o+Math.random()*.5,served:!1,waitingTime:0,isWaiting:this.state.level!==1,patience:g+Math.random()*500,spriteIndex:Math.floor(Math.random()*4),isDrinking:!1,drinkingProgress:0,stepTimer:0};this.state.patrons.push(r)}}}this.state.patrons=this.state.patrons.map(i=>{if(i.isDrinking){const t=i.drinkingProgress+c;return t>=this.DRINKING_TIME?{...i,isDrinking:!1,drinkingProgress:this.DRINKING_TIME,served:!0}:{...i,drinkingProgress:t}}else{if(i.served)return{...i,x:i.x+3*c/16};if(i.isWaiting){const t=i.waitingTime+c;return t>=i.patience?(this.state.health=Math.max(0,this.state.health-30),this.state.recentFailure={type:"timeout",timestamp:Date.now()},this.state.combo=0,{...i,isWaiting:!1,waitingTime:t,served:!0}):{...i,waitingTime:t}}else{const t=i.stepTimer+c,l=200;return t>=l?{...i,x:i.x-8,stepTimer:t-l}:{...i,stepTimer:t}}}}).filter(i=>i.served?i.x<this.CANVAS_WIDTH+50:i.x>this.BARTENDER_X-30),this.state.mugs=this.state.mugs.map(i=>{if(i.state==="sliding_forward")return{...i,x:i.x+i.speed};if(i.state==="at_patron")return i;if(i.state==="sliding_back"){const t=this.MUG_RETURN_SPEED*(1+(this.state.level-1)*.35);return{...i,x:i.x-t}}return i});const{newPatrons:x,newMugs:T,scoreIncrease:b,healthIncrease:v,healthLoss:M}=this.checkMugCollisions();this.state.patrons=x,this.state.mugs=T,this.state.score+=b,this.state.health=Math.min(100,Math.max(0,this.state.health+v-M));const w=[5,10,20],L=Math.max(0,this.state.combo-1);for(const i of w)L<i&&this.state.combo>=i&&this.callbacks.onComboMilestone&&this.callbacks.onComboMilestone(i);const I=this.state.patrons.filter(i=>!i.served&&!i.isDrinking&&i.x<=this.BARTENDER_X+20);this.state.patrons=this.state.patrons.filter(i=>i.served||i.isDrinking||i.x>this.BARTENDER_X+20);const S=I.length*20;this.state.health=Math.max(0,this.state.health-S),this.keysHeld.has(" ")||this.keysHeld.has("Space")?this.state.bartenderState==="IDLE"||this.state.bartenderState==="RECEIVING"?(this.state.isFillingMug=!0,this.state.bartenderState="FILLING_MUG",this.state.bartenderFacing="left",this.state.currentFillLevel=Math.min(this.MAX_FILL,this.state.currentFillLevel+this.FILL_SPEED)):this.state.bartenderState==="FILLING_MUG"&&(this.state.currentFillLevel=Math.min(this.MAX_FILL,this.state.currentFillLevel+this.FILL_SPEED)):this.state.bartenderState==="FILLING_MUG"&&!this.state.isFillingMug&&(this.state.bartenderState="IDLE"),this.state.timeLeft=a,this.state.screenShake>0&&(this.state.screenShake=Math.max(0,this.state.screenShake-.5)),this.state.score>this.state.highScore&&(this.state.highScore=this.state.score,localStorage.setItem("hotcocoatapper_highscore",String(this.state.highScore))),this.state.health<=0&&(this.state.gameOver=!0,this.state.isPlaying=!1),this.updateUI(),this.state.isPlaying&&(this.gameLoopId=requestAnimationFrame(this.gameLoop))};checkMugCollisions(){const s=[...this.state.patrons],e=[...this.state.mugs];let a=0,n=0,c=0;for(let m=this.state.mugs.length-1;m>=0;m--){const o=this.state.mugs[m];if(o.state==="sliding_forward"){for(let g=0;g<this.state.patrons.length;g++){const f=this.state.patrons[g];if(o.lane===f.lane&&o.x>=f.x-20&&o.x<=f.x+40&&!f.served&&!f.isDrinking){const p=Date.now();p-this.state.lastServeTime<this.COMBO_TIMEOUT?this.state.combo++:this.state.combo=1,this.state.lastServeTime=p,this.state.maxCombo=Math.max(this.state.maxCombo,this.state.combo),this.state.totalServes++,o.fillLevel>=this.MIN_ACCEPTABLE_FILL&&this.state.perfectServes++,this.state.combo>=3&&(this.state.screenShake=Math.min(15,this.state.combo*2),this.state.comboPopup={value:this.state.combo,timestamp:p});const b=1+(this.state.combo-1)*.15,v=o.fillLevel>=this.MIN_ACCEPTABLE_FILL?Math.floor(o.fillLevel)+30:5,M=this.state.combo>1?Math.floor(v*(this.state.combo-1)*.3):0,w=Math.floor((v+M)*b);a+=w;const L=60+Math.floor(Math.min(40,o.fillLevel));s[g]={...f,isDrinking:!0,drinkingProgress:0,x:f.x+L,isWaiting:!0},e[m]={...o,state:"at_patron",isEmpty:!1,fillLevel:o.fillLevel,x:f.x,y:f.y,targetPatronId:f.id},n+=2;const I=48,k=s.map((i,t)=>({p:i,idx:t})).filter(({p:i,idx:t})=>t!==g&&i.lane===f.lane&&!i.served&&i.x>=f.x).sort((i,t)=>i.p.x-t.p.x);let S=s[g].x;for(const{p:i,idx:t}of k)if(i.x-S<I){const l=S+I;s[t]={...i,x:l},S=l}else S=i.x;break}}o.x>=this.CANVAS_WIDTH-30&&(e.splice(m,1),c+=5,this.state.combo=0)}else if(o.state==="at_patron"){const g=s.find(f=>f.id===o.targetPatronId);g&&g.x<this.CANVAS_WIDTH?e[m]={...o,x:g.x,y:g.y}:e[m]={...o,state:"sliding_back",isEmpty:!0,fillLevel:0}}else if(o.state==="sliding_back"){const g=this.getLaneY(this.state.bartenderLane),f=o.y,p=o.x<=this.BARTENDER_X+this.CATCH_RANGE&&o.x>=this.BARTENDER_X-20;o.lane===this.state.bartenderLane&&(p&&Math.abs(f-g)<30?(this.state.bartenderState!=="FILLING_MUG"&&(this.state.bartenderState="CATCHING"),this.state.bartenderState==="CATCHING"&&(e.splice(m,1),a+=20)):o.x<=this.BARTENDER_X-40?(e.splice(m,1),c+=15,a-=Math.floor(20*this.state.combo),this.state.recentFailure={type:"miss",timestamp:Date.now()},this.state.combo=0,this.state.bartenderState="IDLE"):this.state.bartenderState!=="FILLING_MUG"&&(this.state.bartenderState="RECEIVING"))}}return{newPatrons:s,newMugs:e,scoreIncrease:a,healthIncrease:n,healthLoss:c}}updateUI(){const s=document.getElementById("score-display"),e=document.getElementById("highscore-display"),a=document.getElementById("health-display"),n=document.getElementById("level-display"),c=document.getElementById("time-display");s&&(s.textContent=String(this.state.score)),e&&(e.textContent=`High Score: ${this.state.highScore}`),a&&(a.textContent=`${Math.floor(this.state.health)}%`),n&&(n.textContent=String(this.state.level)),c&&(c.textContent=String(Math.ceil(this.state.timeLeft/1e3)))}renderLoopId=null;renderLoop=()=>{this.renderer&&this.renderer.render(this.state),this.state.recentFailure&&Date.now()-this.state.recentFailure.timestamp>2e3&&(this.state.recentFailure=void 0),this.renderLoopId=requestAnimationFrame(this.renderLoop)}}document.addEventListener("DOMContentLoaded",()=>{const H=new _e,s={onLevelComplete:(e,a)=>{console.log(`ðŸŽ‰ Level ${e} completed! Score: ${a}`)},onGameOver:(e,a)=>{console.log(`ðŸ˜¢ Game Over! Final Score: ${e}, Level: ${a}`)},onComboMilestone:e=>{console.log(`âš¡ Combo Milestone: ${e}x!`)},onPause:()=>{console.log("Game paused")},onResumeAfterAd:()=>{console.log("Resumed after ad")}};H.setCallbacks(s),H.init()});
